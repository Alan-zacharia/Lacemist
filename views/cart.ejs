<%-include ('partials/header.ejs') %>
<header class="header-area header-style-1 header-height-2">
    <div class="header-top header-top-ptb-1 d-none d-lg-block">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-xl-3 col-lg-4">
                    <div class="header-info">
                        <ul>
                            <li><i class="fi-rs-smartphone"></i> <a href="#">(+01) - 2345 - 6789</a></li>
                            <li><i class="fi-rs-marker"></i><a href="page-contact.html">Our location</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-xl-6 col-lg-4">
                    <div class="text-center">
                        <div id="news-flash" class="d-inline-block">
                            <ul>
                                <li>Get great devices up to 50% off <a href="shop-grid-right.html">View details</a></li>
                                <li>Supper Value Deals - Save more with coupons</li>
                                <li>Trendy 25silver jewelry, save up 35% off today <a href="shop-grid-right.html">Shop
                                        now</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-4">
                    <div class="header-info header-info-right">
                        <ul>
                            <li>
                                <a class="language-dropdown-active" href="#"> <i class="fi-rs-world"></i> English <i
                                        class="fi-rs-angle-small-down"></i></a>
                                <ul class="language-dropdown">
                                    <li><a href="#"><img src="assets/imgs/theme/flag-fr.png" alt="">Français</a></li>
                                    <li><a href="#"><img src="assets/imgs/theme/flag-dt.png" alt="">Deutsch</a></li>
                                    <li><a href="#"><img src="assets/imgs/theme/flag-ru.png" alt="">Pусский</a></li>
                                </ul>
                            </li>
                            <% if (userEmail != null) { %>
                            <li><i class="fa-solid fa-user"></i><a href="/profile">Profile</a></li>

                            <li><i class="fi-rs-user"></i><a href="/logout">Logout</a></li>
                            <% } else { %>
                            <li><i class="fi-rs-user"></i><a href="/login">Log In / Sign Up</a></li>
                            <% } %>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-middle header-middle-ptb-1 d-none d-lg-block">
        <div class="container">
            <div class="header-wrap">
                <div class="logo logo-width-1">
                    <h3><span style="color:rgb(238, 177, 8); font-weight: 900;">LACE</span><span
                            style="color: blue; font-weight: 900;">MIST</span></h3>
                </div>
                <div class="header-right">
                    <div class="search-style-2">

                    </div>
                    <div class="header-action-right">
                        <div class="header-action-2">
                            <div class="header-action-icon-2">
                                <a href="/whislist-view">
                                    <img class="svgInject" alt="Evara" src="assets/imgs/theme/icons/icon-heart.svg">
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-bottom header-bottom-bg-color sticky-bar">
        <div class="container">
            <div class="header-wrap header-space-between position-relative">
                <div class="logo logo-width-1 d-block d-lg-none">
                    <h4><span style="color: hsl(39, 100%, 50%);">LACE</span><span
                            style="color: hwb(240 0% 0%);">MIST</span></h4>
                </div>
                <div class="header-nav d-none d-lg-flex">
                    <div class="main-categori-wrap d-none d-lg-block">
                        <a class="categori-button-active" href="#">
                            &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
                        </a>
                    </div>
                    <div class="main-menu main-menu-padding-1 main-menu-lh-2 d-none d-lg-block">
                        <nav>
                            <ul>
                                <li><a class="active" href="/">Home </a>

                                </li>
                                <li>
                                    <a href="page-about.html">About</a>
                                </li>
                                <li><a href="shop-grid-right.html">Shop </a>


                                <li><a href="#">Pages <i class="fi-rs-angle-down"></i></a>
                                    <ul class="sub-menu">
                                        <li><a href="/profile">My Account</a></li>
                                        <li><a href="/logout">login/register</a></li>
                                        <li><a href="page-404">404 Page</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="header-action-right d-block d-lg-none">
                    <div class="header-action-2">
                        <div class="header-action-icon-2">
                            <a href="/whislist-view">
                                <img alt="lacemist-logo" src="assets/imgs/theme/icons/icon-heart.svg">
                            </a>
                        </div>
                        <div class="header-action-icon-2 d-block d-lg-none">
                            <div class="burger-icon burger-icon-white">
                                <span class="burger-icon-top"></span>
                                <span class="burger-icon-mid"></span>
                                <span class="burger-icon-bottom"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<div class="mobile-header-active mobile-header-wrapper-style">
    <div class="mobile-header-wrapper-inner">
        <div class="mobile-header-top">
            <div class="mobile-header-logo">
                <h4><span style="color: hsl(39, 100%, 50%);">LACE</span><span style="color: hwb(240 0% 0%);">MIST</span>
                </h4>
            </div>
            <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                <button class="close-style search-close">
                    <i class="icon-top"></i>
                    <i class="icon-bottom"></i>
                </button>
            </div>
        </div>
        <div class="mobile-header-content-area">
            <div class="mobile-search search-style-3 mobile-header-border">
                <form action="#">
                    <input type="text" placeholder="Search for items…">
                    <button type="submit"><i class="fi-rs-search"></i></button>
                </form>
            </div>
            <div class="mobile-menu-wrap mobile-header-border">
                <nav>
                    <ul class="mobile-menu">
                        <li class="menu-item-has-children"><span class="menu-expand"></span><a href="/home">Home</a>

                        </li>
                        <li class="menu-item-has-children"><span class="menu-expand"></span><a href="/product">shop</a>
                        </li>
                        <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Pages</a>
                            <ul class="dropdown">
                                <li><a href="/profile">My Account</a></li>
                                <li><a href="/logout">login/register</a></li>
                                <li><a href="page-404">404 Page</a></li>
                            </ul>
                        </li>
                        <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Language</a>
                            <ul class="dropdown">
                                <li><a href="#">English</a></li>
                                <li><a href="#">French</a></li>
                                <li><a href="#">German</a></li>
                                <li><a href="#">Spanish</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
                <!-- mobile menu end -->
            </div>
            <div class="mobile-header-info-wrap mobile-header-border">
                <div class="single-mobile-header-info mt-30">
                    <a href="page-contact.html"> Our location </a>
                </div>
                <div class="single-mobile-header-info">
                    <a href="/profile">Profile</a>
                </div>
                <div class="single-mobile-header-info">
                    <a href="#">(+01) - 2345 - 6789 </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- main -->
<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" rel="nofollow">Home</a>
                <span></span> Your Cart
            </div>
        </div>
    </div>

    <section class="mt-30 mb-30">
        <div class="container p-5" id="alert-box">
            <!-- alert box -->
        </div>
        <% if (cart && cart.items.length > 0 ) { %>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col"></th>
                                    <th scope="col">Image</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% cart.items.forEach((item) =>{ %>
                                <tr>
                                    <td class="checkbox" data-title="Select">
                                        <input type="checkbox" class="product-checkbox h-50" style="display: none;"
                                            data-id="<%= item.product._id %>">
                                    </td>
                                    <td class="image product-thumbnail"><a
                                            href="/product-details/<%= item.product._id %>"><img
                                                src="/<%= item.product.image  %>" alt="#"></a></td>
                                    <td class="product-des product-name">
                                        <h5 class="product-name"><a
                                                href="/product-details/<%= item.product._id %>"><%= item.product.productName %></a>
                                        </h5>
                                        <p class="font-xs"><br>
                                        </p>
                                    </td>
                                    <td class="price" data-title="Price"><span><%= item.product.price %></span></td>
                                    <td class="text-center" data-title="Stock">
                                        <div class="detail-qty border radius m-auto">
                                            <a class="qty-down" data-id="<%= item.product._id %>"><i
                                                    class="fi-rs-angle-small-down"></i></a>
                                            <span class="qty-val" id="qty-<%= item.product._id %>"
                                                data-count-in-stock="<%= item.product.countInStock %>"><%= item.quantity %></span>
                                            <a class="qty-up" data-id="<%= item.product._id %>"><i
                                                    class="fi-rs-angle-small-up"></i></a>
                                        </div>
                                    </td>
                                    <td class="action" data-title="Remove"><button type="button"
                                            onclick="confirmDelete('<%= item.product._id %>')" class="text-muted"><i
                                                class="fi-rs-trash"></i></button></td>
                                </tr>
                                <% })%>
                            </tbody>
                        </table>
                    </div>
                    <div class="cart-action text-end">

                        <a class="btn " href="/"><i class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a>
                    </div>
                    <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i></div>
                    <div class="row mb-50">

                        <div class="col-lg-6 col-md-12">
                            <div class="border p-md-4 p-30 border-radius cart-totals">
                                <a href="/checkVerify" class="btn "> <i class="fi-rs-box-alt mr-10"></i> Proceed To
                                    CheckOut</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%  } else{%>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Cart</h5>
                        </div>
                        <div class="card-body cart">
                            <div class="col-sm-12 empty-cart-cls text-center">
                                <img src="https://i.imgur.com/dCdflKN.png" width="130" height="130"
                                    class="img-fluid mb-4 mr-3">
                                <h3><strong>Your Cart is Empty</strong></h3>
                                <h4>Add something to make me happy :</h4>
                                <a href="/" class="btn btn-primary cart-btn-transform m-3" data-abc="true">continue
                                    shopping</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>
    </section>
</main>
<%- include('partials/footer.ejs') %>
<script>
    function updateBillTotal() {
        const selectedProductIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(checkbox =>
            checkbox.getAttribute('data-id'));

        fetch('/cart/update-cart-total', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    selectedProductIds
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(data); 
                    const totalElement = document.getElementById('total');
                    totalElement.textContent = data.updatedTotal;
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: data.message
                    });
                    console.log(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    document.addEventListener('DOMContentLoaded', function () {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const productId = checkbox.getAttribute('data-id');
            localStorage.setItem(`checkbox_${productId}`, true);
        });
        updateBillTotal();
        const form = document.getElementById('yourFormId');
        form.addEventListener('submit', function (event) {
            const atLeastOneChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
            if (!atLeastOneChecked) {
                event.preventDefault();
                alert('Please select a product.');
                checkboxes[0].focus();
            }
        });
    });

    const updateQuantity = (productId, newQuantity) => {
        fetch('/cart/update-cart-quantity/' + productId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quantity: newQuantity
                }),
            })
            .then((res) => res.json())
            .then((data) => {
                if (data.success) {
                    updateBillTotal();
                } else {
                    console.log(data.message);
                }
            })
            .catch((err) => {
                console.log(err);
            });
    };

    const qtyUpButtons = document.querySelectorAll('.qty-up');
    const qtyDownButtons = document.querySelectorAll('.qty-down');
    qtyUpButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const productId = button.getAttribute('data-id');
            const qtyElement = document.getElementById('qty-' + productId);
            const currentQty = parseInt(qtyElement.textContent);
            const countInStock = parseInt(qtyElement.getAttribute('data-count-in-stock'));
            if (currentQty < countInStock - 1) {
                const newQty = currentQty + 1;
                qtyElement.textContent = newQty;
                updateQuantity(productId, newQty);
            } else {
                console.log('Maximum stock limit reached for product:', productId);
            }
        });
    });

    qtyDownButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const productId = button.getAttribute('data-id');
            const qtyElement = document.getElementById('qty-' + productId);
            const currentQty = parseInt(qtyElement.textContent);
            if (currentQty > 1) {
                const newQty = currentQty - 1;
                qtyElement.textContent = newQty;
                updateQuantity(productId, newQty);
            }
        });
    });

    function confirmDelete(product) {
        Swal.fire({
            title: 'Are you sure ?',
            text: 'You won\'t be able to revert this!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                removeItem(product)
            }
        })
    }

    function removeItem(product) {
        fetch('/cart/remove-product/' + product, {

                method: 'DELETE',
            })
            .then((res) => res.json(), window.location.reload())
            .then((data) => {
                const alertBox = document.getElementById('alert-box');
                let alertHTML = '';

                if (data.success) {
                    updateBillTotal();
                    alertHTML = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="True">&times;</span>
            </button>
            <h4 class="alert-heading">Success</h4>
            <p>${data.message}</p>
        </div>`;
                } else {
                    // Error message (red)
                    alertHTML = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="True">&times;</span>
          </button>
          <h4 class="alert-heading">Error</h4>
          <p>${data.message}</p>
        </div>`;
                }
                alertBox.innerHTML = alertHTML;
                setTimeout(() => {
                    window.location.reload()
                }, 3000)
            })
            .catch((err) => {
                console.log(err)
            })
    }
</script>
